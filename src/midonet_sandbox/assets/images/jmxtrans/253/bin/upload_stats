#!/usr/bin/env bash

while getopts ":b:c:p:" opt; do
    case $opt in
    c)
        COMMITISH=$OPTARG
        ;;
    p)
        PUSHGATEWAY=$OPTARG
        ;;
    esac
done

if [ -z "$COMMITISH" -o -z "$PUSHGATEWAY" ]; then
    echo "Usage: upload_stats -c COMMITISH -p PUSHGATEWAY"
    exit 1
fi

for i in /data/*.txt; do
    /usr/bin/preprocess_stats -f $i
    cat $i | /usr/bin/prometheize -c $COMMITISH \
                                  -j $(basename $i .txt) -p $PUSHGATEWAY ;
done
